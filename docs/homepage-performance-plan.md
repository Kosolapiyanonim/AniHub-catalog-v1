# План поэтапного ускорения главной страницы

## 1) Что лучше всего для скорости

Оптимальная стратегия для текущего стека (Next.js + Supabase):

1. **Сократить критический путь рендера**: сначала показывать только Hero, остальное — догружать потоково.
2. **Разделить данные на critical/deferred**: один быстрый запрос для верхнего экрана, вторичные секции отдельно.
3. **Кэшировать серверные запросы**: `unstable_cache` + `revalidate` для снижения DB-нагрузки и TTFB.
4. **Оптимизировать LCP-изображение**: приоритетная загрузка первого Hero-слайда, более реалистичный `sizes`, уменьшенное качество для фона.

---

## 2) Как сделано сейчас (до изменений)

- Главная страница ожидала полный `getHomepageSections()` перед первым рендером.
- В одном запросе грузились hero + все карусели, что увеличивало время до полной визуализации.
- Критический рендер блокировался вторичными секциями.

---

## 3) Поэтапный план практических изменений

### Этап A (выполнено)
- Разделить фетчеры на:
  - `getHomepageHeroCriticalData()` — только Hero.
  - `getHomepageSectionsDeferred()` — вторичные секции.
- Добавить кэширование `unstable_cache` + `revalidate`.

### Этап B (выполнено)
- Перевести `app/page.tsx` на модель:
  - Hero рендерится сразу.
  - Карусели грузятся через `Suspense` + fallback-скелетон.

### Этап C (выполнено)
- Подкрутить загрузку Hero-изображений:
  - `fetchPriority="high"` для первого слайда.
  - `quality={65}` для фоновых картинок.
  - более точный `sizes`.

### Этап D (следующий шаг)
- Вынести персонализацию (`user_list_status`) из критического пути на клиентскую догрузку после первого рендера.
- Добавить точечную инвалидацию кэша по тегам при изменении hero в админке (`revalidateTag("homepage:hero")`).

### Этап E (следующий шаг)
- Добавить RUM-метрики (LCP p75, TTFB, INP) и compare-before/after дашборд.


### Этап F (выполнено)
- Добавлено структурированное логирование для главной страницы:
  - `traceId`, `stage`, `elapsedMs`, `message`, `error`.
  - Логи по этапам: `hero_critical`, `sections_deferred`, `user_enrichment`, `homepage_full`, `page_render`.
- Теперь в server-логах видно, где именно произошла ошибка (например, конкретная секция) и с каким контекстом.
- Добавлен fallback для Hero: если нет `is_featured_in_hero=true`, используется топ по рейтингу, чтобы главная не оставалась пустой.
- На уровне `app/page.tsx` добавлен безопасный режим: если Hero пустой, показывается компактный баннер и сразу отображаются секции ниже (без полноэкранной заглушки).
- Исправлен конфликт `unstable_cache` + `cookies`: кэшируемые запросы главной переведены на readonly Supabase client без cookie-based auth, чтобы избежать runtime-ошибок на Vercel.

---

## 4) Стратегия перехода

Переход делается **маленькими кусками**:
1. Включить текущие изменения и проверить стабильность (ошибки, визуал, core flow).
2. Снять Lighthouse/Web Vitals после выкатки.
3. Отдельным PR вынести user-specific enrich в deferred-клиентский шаг.
4. Отдельным PR добавить инвалидацию кэша из админки Hero.

Это снижает риск регрессий и позволяет оценивать эффект каждого изменения отдельно.
