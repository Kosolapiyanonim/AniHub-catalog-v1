# Система ролей пользователей

## Описание

Система ролей позволяет разделить пользователей на три категории:
- **admin** - Администраторы с полным доступом (могут удалять любые комментарии)
- **manager** - Менеджеры (зарезервировано для будущего использования)
- **viewer** - Обычные пользователи (роль по умолчанию)

## Установка

1. Выполните SQL миграцию в Supabase SQL Editor:
   ```sql
   -- Файл: scripts/add-user-roles.sql
   ```

2. Миграция автоматически:
   - Добавит поле `role` в таблицу `profiles`
   - Установит роль `viewer` для всех существующих пользователей
   - Обновит функцию создания профилей для новых пользователей

## Назначение ролей

### Через UI (рекомендуется)
Администраторы могут управлять ролями через веб-интерфейс:
1. Перейдите на страницу `/admin/users`
2. Найдите нужного пользователя через поиск
3. Выберите новую роль из выпадающего списка

### Через SQL (альтернативный способ)
Если нужно назначить роль через SQL:

#### Назначить роль администратора:
```sql
UPDATE profiles SET role = 'admin' WHERE id = 'USER_UUID_HERE';
```

#### Назначить роль менеджера:
```sql
UPDATE profiles SET role = 'manager' WHERE id = 'USER_UUID_HERE';
```

#### Вернуть роль зрителя:
```sql
UPDATE profiles SET role = 'viewer' WHERE id = 'USER_UUID_HERE';
```

## Права доступа

### Администраторы (admin)
- ✅ Могут удалять любые комментарии (не только свои)
- ✅ Видят кнопку "Удалить" на всех комментариях
- ✅ Могут управлять ролями других пользователей (через UI `/admin/users` или SQL)
- ✅ Имеют доступ к админ-панели управления пользователями

### Менеджеры (manager)
- ⏳ Зарезервировано для будущего использования

### Зрители (viewer)
- ✅ Могут удалять только свои комментарии
- ✅ Видят кнопку "Удалить" только на своих комментариях

## Использование в коде

### Проверка роли пользователя:
```typescript
import { getUserRole, canDeleteAnyComment, isAdmin } from "@/lib/role-utils"

const userRole = await getUserRole(supabase, userId)
if (isAdmin(userRole)) {
  // Пользователь - администратор
}
```

### Получение полного профиля с ролью:
```typescript
import { getUserProfile } from "@/lib/role-utils"

const profile = await getUserProfile(supabase, userId)
if (profile?.role === 'admin') {
  // Пользователь - администратор
}
```

## API изменения

### GET /api/profile
Теперь возвращает поле `role` в ответе:
```json
{
  "id": "uuid",
  "username": "username",
  "avatar_url": "url",
  "role": "admin" | "manager" | "viewer",
  "created_at": "...",
  "updated_at": "..."
}
```

### DELETE /api/comments
Теперь проверяет роль пользователя:
- Обычные пользователи могут удалять только свои комментарии
- Администраторы могут удалять любые комментарии

### GET /api/admin/users
Получить список пользователей (только для администраторов):
- Поддерживает поиск по имени пользователя или ID
- Возвращает список пользователей с их ролями
- Требует права администратора

### PATCH /api/admin/users
Обновить роль пользователя (только для администраторов):
```json
{
  "userId": "uuid",
  "role": "admin" | "manager" | "viewer"
}
```
- Требует права администратора
- Администратор не может изменить свою собственную роль

## Админ-панель управления пользователями

Доступна по адресу `/admin/users` (только для администраторов).

Функции:
- ✅ Просмотр списка всех пользователей
- ✅ Поиск пользователей по имени или ID
- ✅ Изменение роли пользователя через выпадающий список
- ✅ Отображение текущей роли каждого пользователя
- ✅ Защита от изменения собственной роли администратора

## Будущие улучшения

- [ ] Добавить VIP ранги для пользователей (структура подготовлена в `lib/role-utils.ts`)
- [ ] Расширить права менеджеров
- [x] Добавить UI для управления ролями (админ-панель) ✅
- [ ] Добавить логирование действий администраторов
- [ ] Добавить пагинацию для списка пользователей
- [ ] Добавить фильтрацию по ролям

