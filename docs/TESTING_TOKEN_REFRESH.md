# Инструкция по тестированию обновления JWT токенов

## Быстрая настройка для тестирования

### Шаг 1: Измените JWT expiry в Supabase Dashboard

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в **Authentication** → **Settings**
4. Найдите настройку **"JWT expiry"** (или **"JWT expiration time"**)
5. Измените значение:
   - **Для быстрого теста**: `60` секунд (1 минута)
   - **Для реалистичного теста**: `300` секунд (5 минут)
6. Нажмите **Save**
7. **Важно**: Выйдите и войдите заново, чтобы получить новый токен с новым временем жизни

### Шаг 2: Тестирование

1. Войдите в аккаунт на сайте
2. Подождите истечения токена (1 минуту для быстрого теста, 5 минут для реалистичного)
3. Попробуйте выполнить действие, требующее аутентификации (например, добавить аниме в список)
4. Проверьте логи в `.cursor/debug.log` для анализа процесса обновления токена

## Альтернативные способы симуляции

### Способ A: Удаление cookie через DevTools

1. Откройте DevTools (F12)
2. Перейдите на вкладку **Application** (Chrome) или **Storage** (Firefox)
3. В левой панели: **Cookies** → ваш домен
4. Найдите cookie с именем, содержащим `auth` или `supabase` (например, `sb-xxxxx-auth-token`)
5. **Удалите** этот cookie
6. Обновите страницу — токен будет невалидным

### Способ B: Изменение времени в токене (продвинутый)

Можно декодировать JWT, изменить поле `exp` (expiration time), закодировать обратно и установить в cookie. Это требует больше работы, поэтому рекомендуется использовать Способ 1 или Способ A.

## Что проверять в логах

После тестирования проверьте логи `.cursor/debug.log` на наличие:

1. **Middleware logs**: `Middleware: Before getSession()` и `Middleware: After getSession()`
2. **getAuthenticatedUser logs**: `getUser() result` и `getSession() result (after getUser failed)`
3. **Cookie updates**: `cookies.setAll() called (route handler)` — должно быть при обновлении токена
4. **API route logs**: `Before getAuthenticatedUser()` и `After getAuthenticatedUser()`
5. **Client logs**: `onAuthStateChange event` и `Periodic refresh result`

## Ожидаемое поведение

✅ **Правильное поведение:**
- Токен истекает
- `getUser()` возвращает ошибку "JWT expired"
- `getSession()` автоматически обновляет токен
- `cookies.setAll()` вызывается для сохранения нового токена
- Пользователь остается авторизованным

❌ **Проблемное поведение:**
- Токен истекает
- `getUser()` возвращает ошибку
- `getSession()` не обновляет токен или возвращает `null`
- `cookies.setAll()` не вызывается
- Пользователь видит ошибку "Unauthorized"

## Возврат к нормальным настройкам

После тестирования **обязательно верните JWT expiry обратно на 3600 секунд (1 час)** в Supabase Dashboard, чтобы не создавать проблем для пользователей.

